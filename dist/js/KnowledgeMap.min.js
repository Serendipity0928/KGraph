"use strict";function ownKeys(e,t){var r,n=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)),n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _createForOfIteratorHelper(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,e=function(){};return{s:e,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,i=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(i)throw a}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var $=layui.jquery,element=layui.element,tree=layui.tree,layer=layui.layer,util=layui.util;function layui_init(){element.on("tab(ThemeTab)",function(t){console.log(t.index),2===t.index?$(".main-content").addClass("layui-hide"):$(".main-content").removeClass("layui-hide")}),tree.render({elem:"#test12",showCheckbox:!0,id:"TreeID",isJump:!0,click:function(t){var e=t.data,r=!1;if($(".rect—btn").each(function(){$(this).next().text().trim()===e.title&&(r=!0)}),r)return!1}})}function left_Control(){LinkType_select()}function LinkType_select(){var t=$(".btn-wp");t.click(function(){t.removeClass("active"),$(this).addClass("active"),$("#con_title").html($(this).children("button").text().trim()),LinkContent_change($(this).children("button").text().trim())})}function LinkContent_change(t){"掌握程度"===t&&$.ajax({url:"http://115.29.165.26/operations/person/graph/",type:"POST",data:{typed:"Main"},success:function(t){Refresh_map(t)},error:function(){alert("An error occurred in the requested data due to unknown reasons.")}})}function Array_standard(t){var e={};return e.title=t.name,e.id=t.id,0!==t.children.length&&(e.children=[],t.children.forEach(function(t){e.children.push(Array_standard(t))})),e}function Tree_data_pro(e,t,r){e.forEach(function(t,e){t.children=[]}),t.SubSort(e),t.forEach(function(t){e[t.source].category===e[t.target].category&&0===e[t.target].sub?(e[t.source].children.push(e[t.target]),--e[t.source].sub,--e[t.target].sub):--e[t.source].sub});for(var n=[],a=1;a<=r.length;a++){var o={title:r[a-1].title,id:-a,checked:!1,spread:!0,children:[]};n.push(o)}e.forEach(function(t){0===t.sub&&n[t.category].children.push(Array_standard(t))}),Tree_update(n)}function Tree_update(t){tree.reload("TreeID",{data:t})}function D3_Fun(t){var c,n,e,a,s,r,o,i,u,l=$("#SvgWp"),d=l.width(),f=l.height(),p=d3.select("#SvgWp").append("svg").attr("id","mainsvg").attr("class","svgs").attr("width",d).attr("height",f).on("click",function(){u.attr("class",function(t){return"nodebtn hidebtn btn"+t.index})});var h=d3.drag().on("start",function(t){d3.select(this).raise().attr("stroke","black").attr("r",14),r.stop()}).on("drag",function(t){d3.select(this).attr("cx",t.x=d3.event.x).attr("cy",t.y=d3.event.y),_()}).on("end",function(t){d3.select(this).attr("stroke",null).attr("r",8)}),y=d3.tip().attr("class","d3-tip").html(function(t){return t.name});p.call(y),p.call(d3.zoom().extent([[0,0],[d,f]]).scaleExtent([-5,1.2]).on("zoom",function(){p.attr("transform",d3.event.transform)}));var g,m=p.append("g"),b=m.append("defs"),v="M2,2 L10,6 L2,10 L6,6 L2,2";b.append("marker").attr("id","arrow").attr("markerUnits","userSpaceOnUse").attr("markerWidth","12").attr("markerHeight","12").attr("viewBox","0 0 12 12").attr("refX","18").attr("refY","6").attr("orient","auto").append("path").attr("d",v).attr("fill","#d4d4d4"),b.append("marker").attr("id","arrow_red").attr("markerUnits","userSpaceOnUse").attr("markerWidth","12").attr("markerHeight","12").attr("viewBox","0 0 12 12").attr("refX","18").attr("refY","6").attr("orient","auto").append("path").attr("d",v).attr("fill","red"),(g=p.append("g").append("defs")).append("path").attr("id","action0").attr("d","M3.67394039744206e-15,-40A40,40,0,0,1,37.06339097770921,-18.541019662496844"),g.append("path").attr("id","action1").attr("d","M37.96339097770921,-14.041019662496844A41,41,0,0,1,23.506667,32.36"),g.append("path").attr("id","action2").attr("d","M-25.4442643,38.4039873A48,48,0,0,0,27.4442643,38.4039873"),g.append("path").attr("id","action3").attr("d","M-24.0442643,34.0039873A38,38,0,0,1,-37.96339097770921,-14.541019662496844"),g.append("path").attr("id","action4").attr("d","M-37.96339097770921,-14.541019662496844A40,40,0,0,1,0,-40");function x(){a=m.selectAll(".edgepath").data(n).enter().append("path").attr("class","edgepath").attr("stroke",function(t){return 1===t.path?"red":"#d4d4d4"}).attr("opacity",.8).attr("stroke-width",1).attr("id",function(t,e){return"edgepath"+e}),(o=p.append("g").selectAll(".edgelabel").data(n).enter().append("text").attr("class","edgelabel").style("fill","#cde6c7").style("font-size","10").attr("text-anchor","middle")).append("textPath").attr("xlink:href",function(t,e){return"#edgepath"+e}).style("pointer-events","none").text(function(t){return t.des}),e=m.selectAll("circle").data(c).enter().append("circle").attr("r",8).attr("fill",function(t){return s[t.category].val}).attr("id",function(t){return"circle"+t.index}).on("contextmenu",function(t){d3.event.preventDefault(),console.log("右击"),console.log(t.sub),d3.selectAll(".nodebtn").attr("class",function(t){return"nodebtn hidebtn btn"+t.index}),d3.select(".btn"+t.index).attr("class","nodebtn btn"+t.index)}).on("mouseover",function(t){y.show(t)}).on("mouseout",function(t){y.hide(t)}).call(h),u=p.append("g").selectAll(".nodebtn").data(c).enter().append("g").attr("class",function(t){return"nodebtn hidebtn "+("btn"+t.index)}),function(){for(var r={action0:"M3.67394039744206e-15,-60A60,60,0,0,1,57.06339097770921,-18.541019662496844L28.531695488854606,-9.270509831248422A30,30,0,0,0,1.83697019872103e-15,-30Z",action1:"M57.06339097770921,-18.541019662496844A60,60,0,0,1,35.26711513754839,48.54101966249685L17.633557568774194,24.270509831248425A30,30,0,0,0,28.531695488854606,-9.270509831248422Z",action2:"M35.26711513754839,48.54101966249685A60,60,0,0,1,-35.26711513754838,48.54101966249685L-17.63355756877419,24.270509831248425A30,30,0,0,0,17.633557568774194,24.270509831248425Z",action3:"M-35.26711513754838,48.54101966249685A60,60,0,0,1,-57.06339097770922,-18.541019662496836L-28.53169548885461,-9.270509831248418A30,30,0,0,0,-17.63355756877419,24.270509831248425Z",action4:"M-57.06339097770922,-18.541019662496836A60,60,0,0,1,-1.1021821192326178e-14,-60L-5.510910596163089e-15,-30A30,30,0,0,0,-28.53169548885461,-9.270509831248418Z"},n={action0:["资 源","translate(26.45033635316129,-36.405764746872634)"],action1:["选 择","translate(42.79754323328191,13.905764746872633)"],action2:["详 情","translate(2.7554552980815448e-15,45)"],action3:["编 辑","translate(-42.79754323328191,13.905764746872638)"],action4:["问 答","translate(-26.450336353161298,-36.40576474687263)"]},a=0,o=["action0","action1","action2","action3","action4"];a<o.length;a++)!function(){var e=o[a],t=u.append("g").attr("class","action "+e).style("cursor","pointer").on("click",function(t){Menu_click(e,t)});t.append("path").attr("d",r[e]).attr("fill","#D2D5DA").attr("stroke","#f0f0f4").attr("stroke-width",2).style("opacity",.8),t.append("text").attr("font-size",10).attr("fill","#333").attr("text-anchor","left").append("textPath").attr("xlink:href","#"+e).text(n[e][0]).attr("startOffset",12)}()}(),i=p.append("g").selectAll(".nodelabel").data(c).enter().append("text").attr("class","nodelabel").attr("dy","1em").attr("text-anchor","middle").attr("fill",function(t){return"Plan"===t.map_type?s[t.category].val:"#c23531"}).text(function(t){return t.name}).attr("x",0).attr("y",2);var r="";s.forEach(function(t,e){r+='<div class="rect—btn" style="background: '+t.val+'"></div><span>'+t.title+"</span>"}),$("#Js_legend").html(r)}function _(){c.forEach(function(t){t.x<60?t.x=60:t.x>d-60&&(t.x=d-60),t.y<60?t.y=60:t.y>f-60&&(t.y=f-60)}),a.attr("d",function(t){return"M "+t.source.x+" "+t.source.y+" L "+t.target.x+" "+t.target.y}).attr("marker-end",function(t){return 1===t.path?"url(#arrow_red)":"url(#arrow)"}),o.attr("transform",function(t,e){if(t.target.x<t.source.x){if("none"!==$(this).css("display")&&$(this).css("display")){t=this.getBBox();return"rotate(180 "+(t.x+t.width/2)+" "+(t.y+t.height/2)+")"}return"rotate(0)"}return"rotate(0)"}).attr("x",function(t){var e=Math.abs(t.source.x-t.target.x),t=Math.abs(t.source.y-t.target.y);return Math.sqrt(Math.pow(e,2)+Math.pow(t,2))/2}),e.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}),i.attr("transform",function(t){return"translate("+t.x+","+(t.y+5)+")"}),u.attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}!function(t){n=t.links,c=t.nodes,s=t.color,Tree_data_pro(c,n,s),$("#Js_nodes_num").html(t["#nodes"]);for(var e=0;e<t["#nodes"];e++)c[e].index=e;x(),r=d3.forceSimulation(c).force("charge",d3.forceManyBody().strength(-10).theta(.2).distanceMax(d/4)).force("center",d3.forceCenter(d/2,f/2)).force("link",d3.forceLink(n).distance(function(t){t=t.source.subNum;return t<=5?35:35+5*(t-5)})).force("collision",d3.forceCollide().radius(function(){return 20}).strength(.2)).force("positionY",d3.forceY().strength(.006)).force("myforce",function(){for(var t,e=0,r=c.length;e<r;++e){var n=(t=c[e]).x-d/2,a=t.y-f/2;1<=4*n*n/(f*f)+4*a*a/(d*d)&&(t.vx=-t.vx,t.vy=-t.vy)}}()).alphaTarget(.8).on("tick",_)}(t);t=$("#fresh");t.unbind("click"),t.click(function(){r.stop(),u.attr("class",function(t){return"nodebtn hidebtn btn"+t.index});var t,e=_createForOfIteratorHelper(c);try{for(e.s();!(t=e.n()).done;)item=t.value,item.x=d/2,item.y=f/2}catch(t){e.e(t)}finally{e.f()}p.attr("transform","translate(0,0)"),d=l.width(),f=l.height(),$("#Js_search").next("input").val(""),r.restart()});t=$("#Js_search");t.unbind("click"),t.click(function(){var t,e,r,n=$(this).next("input").val(),a=-1,o=-1,i=_createForOfIteratorHelper(c);try{for(i.s();!(t=i.n()).done;)if(item=t.value,item.name===n){a=item.index,o=item.category;break}}catch(t){i.e(t)}finally{i.f()}-1===a?layer.msg("暂未查找到这个知识点"):(e=d3.select("#circle"+a),r=setInterval(function(){setColor(e,s[o].val)},400),setTimeout(function(){clearInterval(r)},6e3))})}function setColor(t,e){"white"!==t.attr("fill")?t.attr("fill","white"):t.attr("fill",e)}function Menu_click(t,e){switch(t){case"action0":break;case"action1":tree.setChecked("TreeID",e.id)}}function Refresh_map(t){try{$("svg").remove(),D3_Fun(t)}catch(t){console.log(t)}}function request(r){return new Promise(function(e,t){$.ajax(_objectSpread(_objectSpread({},r),{},{success:function(t){"success"===t.status?e(t):layer.msg(t.msg,{icon:2})},error:function(t){layer.msg("An error occurred in the requested data due to unknown reasons.",{icon:5})}}))})}function request_ajax(t){$.ajax(_objectSpread(_objectSpread({},t),{},{success:function(t){"success"===t.status?Refresh_map(t.content):"failure"===t.status?layer.msg(t.msg):Refresh_map(t)},error:function(){alert("An error occurred in the requested data due to unknown reasons.")}}))}$(function(){layui_init(),left_Control(),$.ajax({url:"http://115.29.165.26/operations/person/graph/",type:"POST",data:{typed:"Main"},success:function(t){D3_Fun(t)},error:function(){layer.msg("An error occurred in the requested data due to unknown reasons.",{icon:5})}})}),Array.prototype.delete=function(t){for(var e=[],r=0;r<this.length;r++)r!==t&&e.push(this[r]);return e},Array.prototype.SubSort=function(r){return this.sort(function(t,e){return r[t.target].sub-r[e.target].sub})};